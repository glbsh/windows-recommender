<!DOCTYPE html>
<html>
<head>
  <title>Window Selector</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th { background-color: #eee; }
    input, button, select { margin: 0.5rem 0; padding: 0.4rem; display: block; }
  </style>
</head>
<body>
  <h1>Smart Window Selector</h1>
  <div id="app">Loading...</div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      Papa.parse("verified_window_models.csv", {
        header: true,
        download: true,
        complete: function(results) {
          const verifiedData = results.data.filter(r => r.Brand && r.Series && r.Model);

          const windowDatabase = verifiedData.map(row => ({
            brand: row.Brand,
            series: row.Series,
            model: row.Model,
            frame: row.Frame?.toLowerCase(),
            style: row.Styles?.split(',').map(s => s.trim().toLowerCase()) || [],
            climates: ["cold", "hot", "rainy", "mixed"],
            features: ["energy"].concat(row.STC >= 33 ? ["sound"] : []).concat(row.Warranty?.toLowerCase().includes("life") ? ["warranty"] : []),
            uFactor: parseFloat(row["U-Factor"]),
            stc: parseInt(row.STC),
            warranty: row.Warranty
          }));

          const app = document.getElementById("app");
          let answers = {};

          const questions = [
            {
              key: "climate",
              label: "What's your climate?",
              options: ["cold", "hot", "rainy", "mixed"]
            },
            {
              key: "style",
              label: "Preferred window style?",
              options: ["casement", "sliding", "double-hung", "awning", "picture", "any"]
            },
            {
              key: "material",
              label: "Preferred frame material?",
              options: ["vinyl", "wood", "fiberglass", "recommend"]
            },
            {
              key: "budget",
              label: "What's your budget tier?",
              options: ["any"]
            },
            {
              key: "features",
              label: "Which features matter most? (Ctrl+Click to select multiple)",
              options: ["energy", "sound", "warranty"],
              multi: true
            }
          ];

          let current = 0;

          function askNext() {
            app.innerHTML = "";
            if (current >= questions.length) {
              showResults();
              return;
            }

            const q = questions[current];
            const label = document.createElement("label");
            label.textContent = q.label;
            const select = document.createElement("select");
            if (q.multi) select.multiple = true;
            q.options.forEach(opt => {
              const o = document.createElement("option");
              o.value = opt;
              o.textContent = opt;
              select.appendChild(o);
            });
            const btn = document.createElement("button");
            btn.textContent = "Next";
            btn.onclick = () => {
              answers[q.key] = q.multi ? Array.from(select.selectedOptions).map(o => o.value) : select.value;
              current++;
              askNext();
            };
            app.appendChild(label);
            app.appendChild(select);
            app.appendChild(btn);
          }

          function getRecommendations(answers) {
            const climate = answers.climate;
            return windowDatabase
              .filter(w => w.climates.includes(climate))
              .filter(w => w.style.includes(answers.style) || answers.style === 'any')
              .filter(w => answers.material === 'recommend' || w.frame === answers.material)
              .filter(w => answers.budget === 'any' || w.tier === answers.budget)
              .filter(w => answers.features.every(f => w.features.includes(f)))
              .sort((a, b) => b.stc - a.stc)
              .slice(0, 5);
          }

          function showResults() {
            const models = getRecommendations(answers);
            const container = document.createElement('div');
            const table = document.createElement('table');
            table.innerHTML = `
              <thead>
                <tr><th>Brand</th><th>Series</th><th>Model</th><th>Frame</th><th>Styles</th><th>U-Factor</th><th>STC</th><th>Warranty</th></tr>
              </thead>
              <tbody>
                ${models.map(m => `
                  <tr>
                    <td>${m.brand}</td>
                    <td>${m.series}</td>
                    <td>${m.model}</td>
                    <td>${m.frame}</td>
                    <td>${m.style.join(", ")}</td>
                    <td>${m.uFactor}</td>
                    <td>${m.stc}</td>
                    <td>${m.warranty}</td>
                  </tr>`).join('')}
              </tbody>`;
            container.appendChild(table);
            app.innerHTML = "<h2>Top Recommendations</h2>";
            app.appendChild(container);
          }

          askNext();
        }
      });
    });
  </script>
</body>
</html>